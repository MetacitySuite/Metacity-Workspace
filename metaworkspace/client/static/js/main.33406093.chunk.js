(this["webpackJsonpmetaworkspace-react"]=this["webpackJsonpmetaworkspace-react"]||[]).push([[0],{149:function(e,t,n){},291:function(e,t,n){"use strict";n.r(t);var i=n(2),a=n.n(i),r=n(44),s=n.n(r),o=n(141),c=n(43),l=n(27),d=(n(149),n(150),"/app"),h="/app/login",u="/app/view/:project_name",p="/app/view/",m="/app/projects/:project_name?",f="/app/projects/",b="/app/jobs",g="/app/upload/:project_name",v="/app/upload/",j="/app/style/:project_name/:style_name",y="/app/style/",O="/app/mapping/:project_name",x="/app/mapping/",_="/api/projects",w="/api/project",S="/api/project/rename",L="/api/project",k="/api/project/build",E="/api/project/meta",C="/api/layers",M="/api/layer",N="/api/layer/rename",D="/api/layer",T="/api/layer/enable",A="/api/layer/disable",P="/api/layer/map",R="/api/jobs",I="/api/logs",F="/api/log",B="/auth/user",z="/auth/token",U="/api/styles",H="/api/style",G="/api/style/create",V="/api/style/update",W="/api/style",Y="/api/style/rename",X="/api/style/apply",$="/api/style/parse",K=n(11),J=n(50),Z=n(293),q=n(59),Q=n(78),ee=n.n(Q);var te=ee.a.create({});!function(){var e=localStorage.getItem("JWT");te.defaults.headers.common.Authorization=null===e?null:"Bearer ".concat(e)}();var ne=te,ie=n(32),ae=n(313),re=n(9),se=function(e){return Object(re.jsx)(ae.a,Object(ie.a)({is:c.b},e))};function oe(e){return Object(re.jsxs)(J.a,{className:"header",children:[Object(re.jsx)(se,{to:d,className:"headerLink ".concat(e.home?"selected":""),children:"Home"}),Object(re.jsx)(se,{to:f,className:"headerLink ".concat(e.projects?"selected":""),children:"Projects"}),Object(re.jsx)(se,{to:b,className:"headerLink ".concat(e.jobs?"selected":""),children:"Jobs & Logs"})]})}function ce(){var e=Object(i.useState)([]),t=Object(K.a)(e,2),n=t[0],a=t[1],r=Object(l.g)();return Object(i.useEffect)((function(){return ne.get(_).then((function(e){a(e.data)})),function(){a([])}}),[]),Object(re.jsxs)(J.a,{className:"home",children:[Object(re.jsx)(Z.a,{className:"homeHeading",children:"Metacity"}),Object(re.jsx)(J.a,{className:"homeProjectList",children:n.map((function(e,t){return Object(re.jsx)(q.a,{height:48,onClick:function(){return r.push(p+e)},children:e},t)}))}),Object(re.jsx)(se,{to:f,className:"homeNav",children:"Go to Controls"})]})}var le=n(351),de=n(335),he=n(322),ue=n(323),pe=n(324),me=n(325),fe=n(326),be=n(327),ge=n(328),ve=n(314),je=n(346),ye=n(295),Oe=n(320),xe=n(350);function _e(e){var t=Object(i.createRef)(),n=Object(i.useState)(!1),a=Object(K.a)(n,2),r=a[0],s=a[1],o=Object(i.useState)(!1),c=Object(K.a)(o,2),l=c[0],d=c[1],h=Object(i.useState)(""),u=Object(K.a)(h,2),p=u[0],m=u[1],f=function(n){var i;n&&n.preventDefault();var a=null===(i=t.current)||void 0===i?void 0:i.value;if(a){var r=e.submitBody(a);ne[e.method](e.submitUrl,r).then((function(){t.current&&(t.current.value=""),s(!1),e.onSubmit(a)})).catch((function(t){var n=e.onError(t,a);d(!0),m(n)}))}};return Object(i.useEffect)((function(){m(""),d(!1)}),[r]),Object(re.jsxs)(re.Fragment,{children:[Object(re.jsx)(ve.a,{isShown:r,title:e.title,onConfirm:function(){return f()},onCloseComplete:function(){return s(!1)},confirmLabel:e.confirmLabel,children:Object(re.jsx)("form",{className:"dialogForm",onSubmit:f,children:l?Object(re.jsx)(je.a,{name:"name",label:e.label,description:e.description,placeholder:e.placeholder,ref:t,isInvalid:l,validationMessage:p}):Object(re.jsx)(je.a,{name:"name",label:e.label,description:e.description,placeholder:e.placeholder,ref:t})})}),Object(i.cloneElement)(e.children,{onClick:function(){return s(!0)}})]})}function we(e){var t=Object(i.useState)(!1),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(i.useState)(!1),o=Object(K.a)(s,2),c=o[0],l=o[1],d=Object(i.useState)(""),h=Object(K.a)(d,2),u=h[0],p=h[1];return Object(i.useEffect)((function(){p(""),l(!1)}),[a]),Object(re.jsxs)(re.Fragment,{children:[Object(re.jsxs)(ve.a,{isShown:a,intent:e.intent?e.intent:"none",title:e.title,onConfirm:function(){try{var t=e.submitBody();ne[e.method](e.submitUrl,t).then((function(){r(!1),e.onSubmit()})).catch((function(t){var n=e.onError(t);l(!0),p(n)}))}catch(u){l(!0),p(u)}},onCloseComplete:function(){return r(!1)},confirmLabel:e.confirmLabel,children:[Object(re.jsx)(ye.a,{children:e.label}),c?Object(re.jsx)(Oe.a,{intent:"danger",marginTop:16,children:u}):""]}),e.tooltip?Object(re.jsx)(xe.a,{content:e.tooltip,children:Object(i.cloneElement)(e.children,{onClick:function(){r(!0)}})}):Object(i.cloneElement)(e.children,{onClick:function(){r(!0)}})]})}function Se(e){var t=Object(l.g)();return Object(re.jsxs)(J.a,{className:"actions",children:[Object(re.jsx)(q.a,{marginRight:12,marginBottom:12,appearance:"minimal",iconBefore:he.a,onClick:function(){return t.push(v+e.name)},children:"Add Layer"}),Object(re.jsx)(_e,{submitUrl:G,title:"Add Style",label:"Choose the name of the new style",confirmLabel:"Create",method:"post",submitBody:function(t){return{project:e.name,name:t}},onSubmit:function(n){t.push(y+e.name+"/"+n)},onError:function(e,t){return"Style already exists"},children:Object(re.jsx)(q.a,{marginRight:12,marginBottom:12,appearance:"minimal",iconBefore:ue.a,children:"Add Style"})}),Object(re.jsx)(we,{submitUrl:k,title:"Recompile project ".concat(e.name),label:"Are you sure you want to recompile project ".concat(e.name,"?"),confirmLabel:"Recompile",method:"post",submitBody:function(){return{name:e.name}},onSubmit:function(){t.push(b)},onError:function(e){return"Project could not be recompiled"},tooltip:"Recompile after changing which layers should be included in visualization",children:Object(re.jsx)(q.a,{marginRight:12,marginBottom:12,appearance:"minimal",iconBefore:pe.a,children:"Recompile 3D"})}),Object(re.jsx)(q.a,{marginBottom:12,appearance:"minimal",iconBefore:me.a,onClick:function(){t.push(x+e.name)},children:"Map Layers"}),Object(re.jsx)(q.a,{marginRight:12,marginBottom:12,appearance:"minimal",iconBefore:fe.a,onClick:function(){t.push(p+e.name)},children:"View"}),Object(re.jsx)(_e,{submitUrl:S,title:"Rename project ".concat(e.name),label:"Choose a new name for project ".concat(e.name),confirmLabel:"Rename",method:"post",submitBody:function(t){return{new:t,old:e.name}},onSubmit:e.showProject,onError:function(e,t){return"Project already exists"},children:Object(re.jsx)(q.a,{marginRight:12,marginBottom:12,appearance:"minimal",iconBefore:be.a,children:"Rename"})}),Object(re.jsx)(we,{submitUrl:L,title:"Delete project ".concat(e.name),label:"Do you really want to delete project ".concat(e.name,"?"),confirmLabel:"Delete",method:"delete",intent:"danger",submitBody:function(){return{data:{name:e.name}}},onSubmit:function(){e.showProject()},onError:function(e){return"Project could not be deleted"},children:Object(re.jsx)(q.a,{marginBottom:12,appearance:"minimal",iconBefore:ge.a,intent:"danger",children:"Delete Project"})})]})}var Le=n(344),ke=n(296),Ee=n(297),Ce=n(330),Me=n(331),Ne=n(104);function De(e,t){ne.get(B).then((function(e){t()})).catch((function(t){e.push(h)}))}function Te(){var e=Object(i.useState)(""),t=Object(K.a)(e,2),n=t[0],a=t[1],r=Object(l.g)(),s=Object(i.createRef)(),o=Object(i.createRef)();return Object(i.useEffect)((function(){ne.get(B).then((function(){r.push(f)})).catch((function(e){}))}),[]),Object(re.jsx)(J.a,{className:"fullScreen",children:Object(re.jsxs)(J.a,{children:[Object(re.jsx)(Z.a,{is:"h1",children:"Login"}),n.length>0?Object(re.jsx)("p",{children:n}):"",Object(re.jsxs)("form",{onSubmit:function(e){var t,n;e.preventDefault();var i=new FormData;i.append("username",(null===(t=s.current)||void 0===t?void 0:t.value)||""),i.append("password",(null===(n=o.current)||void 0===n?void 0:n.value)||""),ne.post(z,i,{headers:{"Content-Type":"multipart/form-data"}}).then((function(e){localStorage.setItem("JWT",e.data.access_token),ne.defaults.headers.common.Authorization="Bearer ".concat(e.data.access_token),r.push(f)})).catch((function(e){console.error(e),a("There was a problem with your login, check your username and password.")}))},children:[Object(re.jsx)(Ne.a,{width:"100%",placeholder:"username",ref:s,type:"text"}),Object(re.jsx)(Ne.a,{width:"100%",placeholder:"password",ref:o,type:"password"}),Object(re.jsx)(Ne.a,{type:"submit"})]})]})})}function Ae(e){var t=Object(i.useState)([]),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(l.g)(),o=function(){ne.post(C,{name:e.name}).then((function(e){r(e.data)}))};Object(i.useEffect)((function(){return De(s,(function(){o()})),function(){r([])}}),[e.name]);var c=function(t){t.disabled?ne.post(T,{project:e.name,name:t.name}).then((function(){o()})):ne.post(A,{project:e.name,name:t.name}).then((function(){o()}))};return Object(re.jsxs)(J.a,{className:"section",children:[Object(re.jsx)(J.a,{className:"projectHeader",children:Object(re.jsx)(Z.a,{className:"wide",is:"h3",children:" Layers"})}),Object(re.jsxs)(Le.a,{children:[Object(re.jsxs)(Le.a.Head,{className:"row",children:[Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Layer"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Number of Objects"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Type"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"narrow",children:"include"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"narrow",children:"rename"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"narrow",children:"delete"})]}),Object(re.jsx)(Le.a.Body,{children:a.length>0?a.map((function(t){return Object(re.jsxs)(Le.a.Row,{paddingY:12,height:"auto",className:"row",children:[Object(re.jsx)(Le.a.TextCell,{className:"wide",children:t.name}),Object(re.jsx)(Le.a.TextCell,{className:"wide",children:"number"===typeof t.size?t.size:"".concat(t.size[0]," x ").concat(t.size[1])}),Object(re.jsx)(Le.a.TextCell,{className:"wide",children:t.type}),Object(re.jsx)(Le.a.TextCell,{className:"narrow",children:t.disabled?Object(re.jsx)(ke.a,{icon:Ee.a,appearance:"minimal",onClick:function(){return c(t)}}):Object(re.jsx)(ke.a,{icon:Ce.a,intent:"success",appearance:"minimal",onClick:function(){return c(t)}})}),Object(re.jsx)(Le.a.TextCell,{className:"narrow",children:Object(re.jsx)(_e,{submitUrl:N,title:"Rename layer ".concat(t.name),label:"Choose a new name for layer ".concat(t.name),confirmLabel:"Rename",method:"post",submitBody:function(n){return{project:e.name,new:n,old:t.name}},onSubmit:o,onError:function(e,t){return"Project already exists"},children:Object(re.jsx)(ke.a,{icon:be.a,appearance:"minimal"})})}),Object(re.jsx)(Le.a.TextCell,{className:"narrow",children:Object(re.jsx)(we,{submitUrl:D,title:"Delete layer ".concat(t.name),label:"Do you really want to delete layer ".concat(t.name,"?"),confirmLabel:"Delete",method:"delete",submitBody:function(){return{data:{project:e.name,name:t.name}}},onSubmit:o,onError:function(e){return"Layer could not be deleted"},children:Object(re.jsx)(ke.a,{icon:ge.a,intent:"danger",appearance:"minimal"})})})]},t.name)})):Object(re.jsx)(le.a,{background:"light",title:"No Layers in this Project",orientation:"horizontal",icon:Object(re.jsx)(Me.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5",description:"Layers apper after successfull processing of the input files.",anchorCta:Object(re.jsx)(le.a.LinkButton,{is:se,to:v+e.name,children:"Add first layer"})})})]})]})}function Pe(e){var t=Object(i.useState)([]),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(l.g)(),o=function(){ne.post(U,{name:e.project}).then((function(e){r(e.data)}))};return Object(i.useEffect)((function(){De(s,(function(){o()}))}),[e.project]),Object(re.jsxs)(J.a,{className:"styles",children:[Object(re.jsx)(J.a,{className:"projectHeader",children:Object(re.jsx)(Z.a,{className:"wide",is:"h3",children:"Styles"})}),Object(re.jsx)(J.a,{className:"styleList",children:a.length>0?a.map((function(t){return Object(re.jsxs)(J.a,{className:"styleItem",children:[Object(re.jsx)(J.a,{className:"styleTitle",onClick:function(){s.push(y+e.project+"/"+t)},children:t}),Object(re.jsxs)(J.a,{children:[Object(re.jsx)(_e,{submitUrl:Y,title:"Rename style ".concat(t),label:"Choose a new name for style ".concat(t),confirmLabel:"Rename",method:"post",submitBody:function(n){return{project:e.project,new:n,old:t}},onSubmit:function(){o()},onError:function(e,t){return"Project already exists"},children:Object(re.jsx)(q.a,{marginRight:16,appearance:"minimal",iconBefore:be.a,children:"Rename"})}),Object(re.jsx)(we,{submitUrl:W,title:"Delete style ".concat(t),label:"Do you really want to delete style ".concat(t,"?"),confirmLabel:"Delete",method:"delete",intent:"danger",submitBody:function(){return{data:{project:e.project,name:t}}},onSubmit:function(){o()},onError:function(e){return"Style could not be deleted"},children:Object(re.jsx)(q.a,{appearance:"minimal",intent:"danger",iconBefore:ge.a,children:"Delete"})})]})]},t)})):Object(re.jsx)(le.a,{background:"light",title:"No Styles in this Project",orientation:"vertical",icon:Object(re.jsx)(ue.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5",description:"Styles modify the appearance of the layer in the visualization according to the layer and object metadata"})})]})}function Re(e){return Object(re.jsxs)(J.a,{className:"project",children:[Object(re.jsx)(J.a,{children:Object(re.jsx)(J.a,{className:"projectHeader main",children:Object(re.jsxs)(Z.a,{className:"wide",children:["Project ",e.name]})})}),Object(re.jsx)(Se,{name:e.name,showProject:e.showProject}),Object(re.jsx)(Ae,{name:e.name}),Object(re.jsx)(Pe,{project:e.name})]})}var Ie=n(332),Fe=n(333),Be=n(334);function ze(e){return Object(re.jsxs)(J.a,{className:"list",children:[Object(re.jsx)(Z.a,{className:"projectList title",children:"Projects"}),Object(re.jsx)(_e,{submitUrl:w,title:"Add Project",label:"Choose the name of the new project",confirmLabel:"Create",method:"post",submitBody:function(e){return{name:e}},onSubmit:function(t){e.onSelect(t)},onError:function(e,t){return"Project already exists"},children:Object(re.jsxs)(J.a,{className:"projectList action",children:[Object(re.jsx)(Ie.a,{}),"Add Project"]})}),Object(re.jsx)(Fe.a,{className:"projectList tabs",children:e.projects.map((function(t){return Object(re.jsx)(Be.a,{id:"tab-".concat(t),onSelect:function(){return e.onSelect(t)},isSelected:t===e.currentProject,children:t},t)}))})]})}function Ue(){var e=Object(l.h)().project_name,t=Object(i.useState)(e),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(i.useState)([]),o=Object(K.a)(s,2),c=o[0],d=o[1],h=Object(l.g)(),u=function(){ne.get(_).then((function(e){d(e.data)}))};Object(i.useEffect)((function(){return De(h,(function(){u()})),function(){d([])}}),[]);var p=function(e){u(),r(e);var t=f;e&&(t+=e),h.push(t)};return Object(re.jsxs)(J.a,{children:[Object(re.jsx)(oe,{projects:!0}),Object(re.jsxs)(J.a,{className:"projects",children:[Object(re.jsx)(ze,{currentProject:a,onSelect:p,projects:c}),Object(re.jsx)(J.a,{className:"content ".concat(a?"":"empty"),justifyContent:"center",alignItems:"center",children:a?c.indexOf(a)>-1?Object(re.jsx)(Re,{name:a,showProject:p}):Object(re.jsx)(le.a,{background:"light",title:"Project ".concat(a," not found"),orientation:"vertical",icon:Object(re.jsx)(de.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5"}):Object(re.jsx)(le.a,{background:"light",title:"No project selected",orientation:"vertical",icon:Object(re.jsx)(de.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5"})})]})]})}var He=n(294),Ge=n(61),Ve=n(38),We=n(140),Ye=n(37);function Xe(e){var t=Object(We.a)(),n=t.acceptedFiles,a=t.getRootProps,r=t.getInputProps,s=Object(i.createRef)(),o=n.map((function(e){return Object(re.jsxs)("li",{children:[Object(re.jsx)("span",{className:"fileName",children:e.name}),Object(re.jsxs)("span",{className:"fileSize",children:[e.size," bytes"]})]},e.name)}));return Object(re.jsxs)(J.a,{className:"dropzoneContainer",children:[Object(re.jsxs)("form",{onSubmit:function(t){t.preventDefault(),e.submit(s.current.value,n)},id:"layerUploadForm",children:[Object(re.jsx)(Ne.a,{placeholder:"layer name",ref:s,className:"layerName"}),Object(re.jsxs)("div",Object(ie.a)(Object(ie.a)({},a({className:"dropzone"})),{},{children:[Object(re.jsx)("input",Object(ie.a)({},r())),Object(re.jsx)("p",{children:"Click or drag 'n' drop layer files here"}),Object(re.jsx)("ul",{className:"filelist",children:o})]}))]}),Object(re.jsx)(q.a,{appearance:"primary",type:"submit",form:"layerUploadForm",children:"Upload"})]})}function $e(){var e=Object(l.h)().project_name,t=Object(l.g)(),n=Object(i.useState)(0),a=Object(K.a)(n,2),r=a[0],s=a[1],o=Object(i.useState)(!1),c=Object(K.a)(o,2),d=c[0],h=c[1];Object(i.useEffect)((function(){De(t,(function(){}))}),[]);return Object(re.jsxs)(J.a,{children:[Object(re.jsx)(oe,{projects:!0}),Object(re.jsxs)(J.a,{className:"upload",children:[d?Object(re.jsx)(He.a,{}):Object(re.jsx)(Ge.a,{icon:Me.a,size:30,color:"#C1C4D6",background:"#EDEFF5",className:"uploadIcon",padding:20,borderRadius:40}),Object(re.jsxs)(Z.a,{className:"uploadTitle",children:["Uploading Layer to Project ",e]}),d?Object(re.jsx)(J.a,{className:"progress",children:Object(re.jsxs)(Ve.a,{className:"label",children:[r.toFixed(0),"%"]})}):Object(re.jsx)(Xe,{submit:function(n,i){if(!d)if(void 0!==n&&0!=n.length)if(void 0!==i&&0!=i.length){h(!0);var a=new FormData;a.append("project",e),a.append("layer",n),i.forEach((function(e){a.append("files",e)})),ne.post(M,a,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:function(e){return s(e.loaded/e.total*100)}}).then((function(e){t.push(b)}))}else Object(Ye.b)("No files provided");else Object(Ye.b)("No name specified")}})]})]})}var Ke=n(352),Je=n(336),Ze=n(337),qe=n(338),Qe=n(137),et=n.n(Qe);function tt(){var e,t=Object(i.useState)([]),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(i.useState)(void 0),o=Object(K.a)(s,2),c=o[0],l=o[1],d=Object(i.useState)(!1),h=Object(K.a)(d,2),u=h[0],p=h[1],m=function t(){ne.get(R).then((function(n){r(n.data),e=setTimeout(t,2e3)}))};return Object(i.useEffect)((function(){return m(),function(){clearTimeout(e),r([])}}),[]),Object(re.jsxs)(J.a,{children:[Object(re.jsx)(Ke.a,{isShown:u,onCloseComplete:function(){return p(!1)},preventBodyScrolling:!0,children:Object(re.jsxs)(J.a,{className:"jsonRaw",children:[Object(re.jsxs)(Z.a,{className:"jsonHeading",children:["Job ",null===c||void 0===c?void 0:c.job_id]}),Object(re.jsx)(J.a,{className:"json",children:Object(re.jsx)(et.a,{src:c,enableClipboard:!1,theme:{base00:"#FFF",base01:"#DDD",base02:"#DDD",base03:"#444",base04:"#BBB",base05:"#444",base06:"#444",base07:"#444",base08:"#444",base09:"#3366FF",base0A:"#3366FF",base0B:"#3366FF",base0C:"#3366FF",base0D:"#BBB",base0E:"#BBB",base0F:"#3366FF"}})})]})}),Object(re.jsxs)(Le.a,{children:[Object(re.jsxs)(Le.a.Head,{className:"row",children:[Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Job Type"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Status"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"wide",children:"Project"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"narrow",children:"Log"}),Object(re.jsx)(Le.a.TextHeaderCell,{className:"narrow",children:"Raw"})]}),Object(re.jsx)(Le.a.Body,{children:a.length>0?a.map((function(e){return Object(re.jsxs)(Le.a.Row,{paddingY:12,height:"auto",className:"row",children:[Object(re.jsx)(Le.a.TextCell,{className:"wide",children:e.type}),Object(re.jsx)(Le.a.TextCell,{className:"wide",children:e.status}),Object(re.jsx)(Le.a.TextCell,{className:"wide",children:e.project?e.project:"--"}),Object(re.jsx)(Le.a.TextCell,{className:"narrow",children:Object(re.jsx)(ke.a,{icon:Je.a,onClick:function(){},disabled:!0})}),Object(re.jsx)(Le.a.TextCell,{className:"narrow",children:Object(re.jsx)(ke.a,{icon:Ze.a,onClick:function(){l(e),p(!0)}})})]},e.job_id)})):Object(re.jsx)(le.a,{background:"light",title:"No Running Jobs",orientation:"horizontal",icon:Object(re.jsx)(qe.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5",description:"Jobs run in the background and process input data into visualizable elements"})})]})]})}var nt=n(339);function it(e){var t,n=Object(i.useState)(""),a=Object(K.a)(n,2),r=a[0],s=a[1],o=function n(){ne.post(F,{name:e.name}).then((function(e){s(e.data),t=setTimeout(n,2e3)}))};return Object(i.useEffect)((function(){return o(),function(){s(""),clearTimeout(t)}}),[e.name]),Object(re.jsx)(J.a,{className:"logContents",children:r&&r.length>0?Object(re.jsx)(nt.a,{className:"logLines",children:r.split(/[\r\n]+/).map((function(e,t){return Object(re.jsx)("span",{children:e},t)}))}):Object(re.jsx)(nt.a,{children:"No contents"})})}function at(){var e,t=Object(i.useState)([]),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(i.useState)(void 0),o=Object(K.a)(s,2),c=o[0],l=o[1],d=function t(){ne.get(I).then((function(n){r(n.data),e=setTimeout(t,2e3)}))};return Object(i.useEffect)((function(){return d(),function(){r([]),clearTimeout(e)}}),[]),Object(re.jsxs)(J.a,{children:[Object(re.jsx)(Fe.a,{className:"logList",marginBottom:16,flexBasis:240,marginRight:24,children:a.map((function(e,t){return Object(re.jsx)(Be.a,{id:e,onSelect:function(){return l(e)},isSelected:e===c,"aria-controls":"panel-".concat(e),className:"logTab",children:e},e)}))}),Object(re.jsx)(J.a,{children:c?Object(re.jsx)(it,{name:c}):Object(re.jsx)(le.a,{background:"light",title:"No Log selected",orientation:"horizontal",icon:Object(re.jsx)(Je.a,{color:"#C1C4D6"}),iconBgColor:"#EDEFF5",description:"Logs contain debug information for running processes"})})]})}function rt(){var e=Object(l.g)();return Object(i.useEffect)((function(){De(e,(function(){}))}),[]),Object(re.jsxs)(J.a,{children:[Object(re.jsx)(oe,{jobs:!0}),Object(re.jsxs)(J.a,{className:"jobs",children:[Object(re.jsx)(Z.a,{className:"jobsHeading",children:"Jobs"}),Object(re.jsx)(tt,{})]}),Object(re.jsxs)(J.a,{className:"logs",children:[Object(re.jsx)(Z.a,{className:"logsHeading",children:"Logs"}),Object(re.jsx)(at,{})]})]})}var st=n(340),ot=n(345),ct=n(341);function lt(){var e=Object(l.h)().project_name,t=Object(i.useState)([]),n=Object(K.a)(t,2),a=n[0],r=n[1],s=Object(i.useState)(void 0),o=Object(K.a)(s,2),c=o[0],d=o[1],h=Object(i.useState)(void 0),u=Object(K.a)(h,2),p=u[0],m=u[1],f=Object(i.createRef)(),b=Object(l.g)();Object(i.useEffect)((function(){return De(b,(function(){ne.post(C,{name:e}).then((function(e){r(e.data.filter((function(e){return"layer"===e.type})))}))})),function(){r([])}}),[e]);return Object(re.jsxs)(J.a,{children:[Object(re.jsx)(oe,{projects:!0}),Object(re.jsxs)(J.a,{className:"mapping",children:[Object(re.jsx)(Ge.a,{icon:me.a,size:30,color:"#C1C4D6",background:"#EDEFF5",className:"uploadIcon",padding:20,borderRadius:40}),Object(re.jsxs)(Z.a,{className:"mappingTitle",children:["Layer mapping in Project ",e]}),Object(re.jsxs)(J.a,{className:"mappingDialog",children:[Object(re.jsxs)("form",{onSubmit:function(t){t.preventDefault();var n=f.current.value;void 0!==n&&0!=n.length?void 0!==c&&void 0!==p?c!==p?ne.post(P,{project:e,source:c,target:p,overlay:n}).then((function(){Ye.b.success("Mapping layers successfully.")})).catch((function(){Ye.b.error("Mapping layers failed.")})):Ye.b.error("Source and target layer cannot be same."):Ye.b.error("Please select source and target layer."):Ye.b.error("No name specified.")},id:"layerMappingForm",children:[Object(re.jsx)(Ne.a,{placeholder:"overlay name",ref:f,className:"layerName"}),Object(re.jsxs)(ye.a,{className:"mappingDescription",children:["Geometry of source layer is mapped onto geometry of target layer. The output of this operation is a new layer with type ",Object(re.jsx)(st.a,{size:300,children:"overlay"}),". The ",Object(re.jsx)(st.a,{size:300,children:"source"})," layer can contain any geometry, the ",Object(re.jsx)(st.a,{size:300,children:"target"})," layer must contain any ",Object(re.jsx)(st.a,{size:300,children:"polygons"}),"."]}),Object(re.jsxs)(J.a,{className:"mappingLayerPicker",children:[Object(re.jsx)(ot.a,{title:"Select source layer",options:a.map((function(e){return{label:e.name,value:e.name}})),selected:c,onSelect:function(e){return d(e.value)},children:Object(re.jsx)(xe.a,{content:"Can contain 2D or 3D points, lines or polygons",children:Object(re.jsx)(q.a,{type:"button",children:c||"select source layer"})})}),Object(re.jsx)(J.a,{className:"dialogPart",children:Object(re.jsx)(Ge.a,{icon:ct.a,color:"#C1C4D6"})}),Object(re.jsx)(ot.a,{title:"Select target layer",options:a.map((function(e){return{label:e.name,value:e.name}})),selected:p,onSelect:function(e){return m(e.value)},children:Object(re.jsx)(xe.a,{content:"Must contain 2D or 3D polygons",children:Object(re.jsx)(q.a,{type:"button",children:p||"select target layer"})})})]})]}),Object(re.jsx)(q.a,{appearance:"primary",type:"submit",form:"layerMappingForm",children:"Apply Mapping"})]})]})]})}var dt=n(353),ht=n(342),ut=n(0),pt=n(1),mt=n(14),ft=new mt.u,bt=function(){function e(t){Object(ut.a)(this,e),t=t||{},this.vertices={near:[new mt.O,new mt.O,new mt.O,new mt.O],far:[new mt.O,new mt.O,new mt.O,new mt.O]},void 0!==t.projectionMatrix&&this.setFromProjectionMatrix(t.projectionMatrix,t.maxFar||1e4)}return Object(pt.a)(e,[{key:"setFromProjectionMatrix",value:function(e,t){var n=0===e.elements[11];return ft.copy(e).invert(),this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach((function(e){e.applyMatrix4(ft)})),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1),this.vertices.far.forEach((function(e){e.applyMatrix4(ft);var i=Math.abs(e.z);n?e.z*=Math.min(t/i,1):e.multiplyScalar(Math.min(t/i,1))})),this.vertices}},{key:"split",value:function(t,n){for(;t.length>n.length;)n.push(new e);n.length=t.length;for(var i=0;i<t.length;i++){var a=n[i];if(0===i)for(var r=0;r<4;r++)a.vertices.near[r].copy(this.vertices.near[r]);else for(var s=0;s<4;s++)a.vertices.near[s].lerpVectors(this.vertices.near[s],this.vertices.far[s],t[i-1]);if(i===t.length-1)for(var o=0;o<4;o++)a.vertices.far[o].copy(this.vertices.far[o]);else for(var c=0;c<4;c++)a.vertices.far[c].lerpVectors(this.vertices.near[c],this.vertices.far[c],t[i])}}},{key:"toSpace",value:function(e,t){for(var n=0;n<4;n++)t.vertices.near[n].copy(this.vertices.near[n]).applyMatrix4(e),t.vertices.far[n].copy(this.vertices.far[n]).applyMatrix4(e)}}]),e}(),gt={lights_fragment_begin:"\nGeometricContext geometry;\n\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\n#ifdef CLEARCOAT\n\n\tgeometry.clearcoatNormal = clearcoatNormal;\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0) && defined( RE_Direct ) && defined( USE_CSM ) && defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\tfloat linearDepth = (vViewPosition.z) / (shadowFar - cameraNear);\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#if defined( USE_SHADOWMAP ) && defined( CSM_FADE )\n\tvec2 cascade;\n\tfloat cascadeCenter;\n\tfloat closestEdge;\n\tfloat margin;\n\tfloat csmx;\n\tfloat csmy;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\n\t\t// NOTE: Depth gets larger away from the camera.\n\t\t// cascade.x is closer, cascade.y is further\n\t\tcascade = CSM_cascades[ i ];\n\t\tcascadeCenter = ( cascade.x + cascade.y ) / 2.0;\n\t\tclosestEdge = linearDepth < cascadeCenter ? cascade.x : cascade.y;\n\t\tmargin = 0.25 * pow( closestEdge, 2.0 );\n\t\tcsmx = cascade.x - margin / 2.0;\n\t\tcsmy = cascade.y + margin / 2.0;\n\t\tif( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS && linearDepth >= csmx && ( linearDepth < csmy || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 ) ) {\n\n\t\t\tfloat dist = min( linearDepth - csmx, csmy - linearDepth );\n\t\t\tfloat ratio = clamp( dist / margin, 0.0, 1.0 );\n\t\t\tif( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS ) {\n\n\t\t\t\tvec3 prevColor = directLight.color;\n\t\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\t\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t\t\tbool shouldFadeLastCascade = UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth > cascadeCenter;\n\t\t\t\tdirectLight.color = mix( prevColor, directLight.color, shouldFadeLastCascade ? ratio : 1.0 );\n\n\t\t\t}\n\n\t\t\tReflectedLight prevLight = reflectedLight;\n\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t\t\tbool shouldBlend = UNROLLED_LOOP_INDEX != CSM_CASCADES - 1 || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth < cascadeCenter;\n\t\t\tfloat blendRatio = shouldBlend ? ratio : 1.0;\n\n\t\t\treflectedLight.directDiffuse = mix( prevLight.directDiffuse, reflectedLight.directDiffuse, blendRatio );\n\t\t\treflectedLight.directSpecular = mix( prevLight.directSpecular, reflectedLight.directSpecular, blendRatio );\n\t\t\treflectedLight.indirectDiffuse = mix( prevLight.indirectDiffuse, reflectedLight.indirectDiffuse, blendRatio );\n\t\t\treflectedLight.indirectSpecular = mix( prevLight.indirectSpecular, reflectedLight.indirectSpecular, blendRatio );\n\n\t\t}\n\n\t}\n\t#pragma unroll_loop_end\n\t#else\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y) directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t#endif\n\n\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && (linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1)) RE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM ) && !defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry.normal );\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",lights_pars_begin:"\n#if defined( USE_CSM ) && defined( CSM_CASCADES )\nuniform vec2 CSM_cascades[CSM_CASCADES];\nuniform float cameraNear;\nuniform float shadowFar;\n#endif\n\t"+mt.H.lights_pars_begin},vt=new mt.u,jt=new bt,yt=new mt.O,Ot=new mt.b,xt=[],_t=[],wt=function(){function e(t){Object(ut.a)(this,e),t=t||{},this.camera=t.camera,this.parent=t.parent,this.cascades=t.cascades||3,this.maxFar=t.maxFar||1e5,this.mode=t.mode||"practical",this.shadowMapSize=t.shadowMapSize||2048,this.shadowBias=[];for(var n=0;n<this.cascades;++n)this.shadowBias.push(t.shadowBias?t.shadowBias[n]:1e-6);this.lightDirection=t.lightDirection||new mt.O(1,-1,1).normalize(),this.lightIntensity=t.lightIntensity||1,this.lightNear=t.lightNear||1,this.lightFar=t.lightFar||2e3,this.lightMargin=t.lightMargin||200,this.customSplitsCallback=t.customSplitsCallback,this.fade=!1,this.mainFrustum=new bt,this.frustums=[],this.breaks=[],this.lights=[],this.shaders=new Map,this.createLights(),this.updateFrustums(),this.injectInclude()}return Object(pt.a)(e,[{key:"createLights",value:function(){for(var e=0;e<this.cascades;e++){var t=new mt.g(16777215,this.lightIntensity);t.castShadow=!0,t.shadow.mapSize.width=this.shadowMapSize,t.shadow.mapSize.height=this.shadowMapSize,t.shadow.camera.near=this.lightNear,t.shadow.camera.far=this.lightFar,t.shadow.bias=this.shadowBias[e],this.parent.add(t),this.parent.add(t.target),this.lights.push(t)}}},{key:"initCascades",value:function(){var e=this.camera;e.updateProjectionMatrix(),this.mainFrustum.setFromProjectionMatrix(e.projectionMatrix,this.maxFar),this.mainFrustum.split(this.breaks,this.frustums)}},{key:"updateShadowBounds",value:function(){for(var e=this.frustums,t=0;t<e.length;t++){var n=this.lights[t].shadow.camera,i=this.frustums[t],a=i.vertices.near,r=i.vertices.far,s=r[0],o=void 0;o=s.distanceTo(r[2])>s.distanceTo(a[2])?r[2]:a[2];var c=s.distanceTo(o);if(this.fade){var l=this.camera,d=Math.max(l.far,this.maxFar),h=i.vertices.far[0].z/(d-l.near);c+=.25*Math.pow(h,2)*(d-l.near)}n.left=-c/2,n.right=c/2,n.top=c/2,n.bottom=-c/2,n.updateProjectionMatrix()}}},{key:"getBreaks",value:function(){var e=this.camera,t=Math.min(e.far,this.maxFar);switch(this.breaks.length=0,this.mode){case"uniform":n(this.cascades,e.near,t,this.breaks);break;case"logarithmic":i(this.cascades,e.near,t,this.breaks);break;case"practical":!function(e,t,a,r,s){xt.length=0,_t.length=0,i(e,t,a,_t),n(e,t,a,xt);for(var o=1;o<e;o++)s.push(mt.t.lerp(xt[o-1],_t[o-1],r));s.push(1)}(this.cascades,e.near,t,.8,this.breaks);break;case"custom":void 0===this.customSplitsCallback&&console.error("CSM: Custom split scheme callback not defined."),this.customSplitsCallback(this.cascades,e.near,t,this.breaks)}function n(e,t,n,i){for(var a=1;a<e;a++)i.push((t+(n-t)*a/e)/n);i.push(1)}function i(e,t,n,i){for(var a=1;a<e;a++)i.push(t*Math.pow(n/t,a/e)/n);i.push(1)}}},{key:"update",value:function(){for(var e=this.camera,t=this.frustums,n=0;n<t.length;n++){var i=this.lights[n],a=i.shadow.camera,r=(a.right-a.left)/this.shadowMapSize,s=(a.top-a.bottom)/this.shadowMapSize;i.shadow.camera.updateMatrixWorld(!0),vt.multiplyMatrices(i.shadow.camera.matrixWorldInverse,e.matrixWorld),t[n].toSpace(vt,jt);var o=jt.vertices.near,c=jt.vertices.far;Ot.makeEmpty();for(var l=0;l<4;l++)Ot.expandByPoint(o[l]),Ot.expandByPoint(c[l]);Ot.getCenter(yt),yt.z=Ot.max.z+this.lightMargin,yt.x=Math.floor(yt.x/r)*r,yt.y=Math.floor(yt.y/s)*s,yt.applyMatrix4(i.shadow.camera.matrixWorld),i.position.copy(yt),i.target.position.copy(yt),i.target.position.x+=this.lightDirection.x,i.target.position.y+=this.lightDirection.y,i.target.position.z+=this.lightDirection.z}}},{key:"injectInclude",value:function(){mt.H.lights_fragment_begin=gt.lights_fragment_begin,mt.H.lights_pars_begin=gt.lights_pars_begin}},{key:"setupMaterial",value:function(e){e.defines=e.defines||{},e.defines.USE_CSM=1,e.defines.CSM_CASCADES=this.cascades,this.fade&&(e.defines.CSM_FADE="");var t=[],n=this,i=this.shaders;e.onBeforeCompile=function(a){var r=Math.min(n.camera.far,n.maxFar);n.getExtendedBreaks(t),a.uniforms.CSM_cascades={value:t},a.uniforms.cameraNear={value:n.camera.near},a.uniforms.shadowFar={value:r},i.set(e,a)},i.set(e,null)}},{key:"updateUniforms",value:function(){var e=Math.min(this.camera.far,this.maxFar);this.shaders.forEach((function(t,n){if(null!==t){var i=t.uniforms;this.getExtendedBreaks(i.CSM_cascades.value),i.cameraNear.value=this.camera.near,i.shadowFar.value=e}!this.fade&&"CSM_FADE"in n.defines?(delete n.defines.CSM_FADE,n.needsUpdate=!0):this.fade&&!("CSM_FADE"in n.defines)&&(n.defines.CSM_FADE="",n.needsUpdate=!0)}),this)}},{key:"getExtendedBreaks",value:function(e){for(;e.length<this.breaks.length;)e.push(new mt.N);e.length=this.breaks.length;for(var t=0;t<this.cascades;t++){var n=this.breaks[t],i=this.breaks[t-1]||0;e[t].x=i,e[t].y=n}}},{key:"updateFrustums",value:function(){this.getBreaks(),this.initCascades(),this.updateShadowBounds(),this.updateUniforms()}},{key:"remove",value:function(){for(var e=0;e<this.lights.length;e++)this.parent.remove(this.lights[e])}},{key:"dispose",value:function(){var e=this.shaders;e.forEach((function(e,t){delete t.onBeforeCompile,delete t.defines.USE_CSM,delete t.defines.CSM_CASCADES,delete t.defines.CSM_FADE,null!==e&&(delete e.uniforms.CSM_cascades,delete e.uniforms.cameraNear,delete e.uniforms.shadowFar),t.needsUpdate=!0})),e.clear()}}]),e}(),St=n(4),Lt=n(5),kt=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e){var i;Object(ut.a)(this,n),(i=t.call(this)).csm=e,i.displayFrustum=!0,i.displayPlanes=!0,i.displayShadowBounds=!0;var a=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),s=new mt.e;s.setIndex(new mt.d(a,1)),s.setAttribute("position",new mt.d(r,3,!1));var o=new mt.r(s,new mt.p);return i.add(o),i.frustumLines=o,i.cascadeLines=[],i.cascadePlanes=[],i.shadowLines=[],i}return Object(pt.a)(n,[{key:"updateVisibility",value:function(){for(var e=this.displayFrustum,t=this.displayPlanes,n=this.displayShadowBounds,i=this.frustumLines,a=this.cascadeLines,r=this.cascadePlanes,s=this.shadowLines,o=0,c=a.length;o<c;o++){var l=a[o],d=r[o],h=s[o];l.visible=e,d.visible=e&&t,h.visible=n}i.visible=e}},{key:"update",value:function(){var e=this.csm,t=e.camera,n=e.cascades,i=e.mainFrustum,a=e.frustums,r=e.lights,s=this.frustumLines.geometry.getAttribute("position"),o=this.cascadeLines,c=this.cascadePlanes,l=this.shadowLines;for(this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.updateMatrixWorld(!0);o.length>n;)this.remove(o.pop()),this.remove(c.pop()),this.remove(l.pop());for(;o.length<n;){var d=new mt.c(new mt.b,0),h=new mt.w({color:0,transparent:!0,opacity:.1,depthWrite:!1,side:mt.h}),u=new mt.v(new mt.D,h),p=new mt.k,m=new mt.c(new mt.b,16711680);p.add(m),this.add(d),this.add(u),this.add(p),o.push(d),c.push(u),l.push(p)}for(var f=0;f<n;f++){var b=a[f],g=r[f].shadow.camera,v=b.vertices.far,j=o[f],y=c[f],O=l[f],x=O.children[0];j.box.min.copy(v[2]),j.box.max.copy(v[0]),j.box.max.z+=1e-4,y.position.addVectors(v[0],v[2]),y.position.multiplyScalar(.5),y.scale.subVectors(v[0],v[2]),y.scale.z=1e-4,this.remove(O),O.position.copy(g.position),O.quaternion.copy(g.quaternion),O.scale.copy(g.scale),O.updateMatrixWorld(!0),this.attach(O),x.box.min.set(g.bottom,g.left,-g.far),x.box.max.set(g.top,g.right,-g.near)}var _=i.vertices.near,w=i.vertices.far;s.setXYZ(0,w[0].x,w[0].y,w[0].z),s.setXYZ(1,w[3].x,w[3].y,w[3].z),s.setXYZ(2,w[2].x,w[2].y,w[2].z),s.setXYZ(3,w[1].x,w[1].y,w[1].z),s.setXYZ(4,_[0].x,_[0].y,_[0].z),s.setXYZ(5,_[3].x,_[3].y,_[3].z),s.setXYZ(6,_[2].x,_[2].y,_[2].z),s.setXYZ(7,_[1].x,_[1].y,_[1].z),s.needsUpdate=!0}}]),n}(mt.k),Et=(n(106),n(6)),Ct=function(){function e(t){Object(ut.a)(this,e),this.pickingTexture=void 0,this.pixelBuffer=void 0,this.renderer=void 0,this.selected=void 0,this.id=void 0,this.offsets=void 0,this.maxOffest=void 0,this.pickingTexture=new mt.P(1,1),this.pixelBuffer=new Uint8Array(4),this.renderer=t,this.selected=[-1,-1,-1,-1],this.id=-1,this.offsets=new Map,this.maxOffest=0}return Object(pt.a)(e,[{key:"offsetForLayer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;if(!this.offsets.has(e)){if(-1===t)throw new Error("Layer ".concat(e," not registered."));this.offsets.set(e,[this.maxOffest,this.maxOffest+t]),this.maxOffest+=t}var n=this.offsets.get(e);return n[0]}},{key:"layerAndOidForId",value:function(e){var t,n=Object(Et.a)(this.offsets.entries());try{for(n.s();!(t=n.n()).done;){var i=Object(K.a)(t.value,2),a=i[0],r=i[1];if(e>=r[0]&&e<r[1])return{layer:a,oid:e-r[0]}}}catch(s){n.e(s)}finally{n.f()}}},{key:"select",value:function(e){this.id=e;var t=new Uint32Array([e]),n=new DataView(t.buffer);this.selected=[n.getUint8(0)/255,n.getUint8(1)/255,n.getUint8(2)/255,n.getUint8(3)/255]}},{key:"pick",value:function(e,t,n,i){var a=this.pickingTexture,r=this.pixelBuffer,s=this.renderer.getPixelRatio();return i.setViewOffset(this.renderer.getContext().drawingBufferWidth,this.renderer.getContext().drawingBufferHeight,e*s|0,t*s|0,1,1),this.renderer.setRenderTarget(a),this.renderer.render(n,i),this.renderer.setRenderTarget(null),i.clearViewOffset(),this.renderer.readRenderTargetPixels(a,0,0,1,1,r),this.selected=[r[0]/255,r[1]/255,r[2]/255,r[3]/255],this.id=new DataView(r.buffer).getUint32(0,!0),this.id}}]),e}();var Mt,Nt=function e(t){Object(ut.a)(this,e),this.polygonMaterial=void 0,this.polygonSelectMaterial=void 0,this.lineMaterial=void 0,this.pickingMaterial=void 0,this.lineSelectorMaterial=void 0,this.polygonMaterial=new mt.x({side:mt.h}),this.polygonSelectMaterial=function(){var e=mt.M.merge([mt.I.phong.uniforms,{selectedID:{value:[-1,-1,-1,-1]}},{shininess:{value:1e3}}]);return new mt.J({uniforms:e,vertexShader:"\n#define PHONG\n\nvarying vec3 vViewPosition;\n\nuniform vec4 selectedID;\n\nattribute vec4 objectID;\nattribute vec3 color;\nvarying float varyingObjectID;\nvarying vec3 colorFrag;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n    int marked = 1;\n\n    for(int i = 0; i < 4; ++i)\n        marked *= int(floor(selectedID[i] * 255.0 + 0.5) == floor(objectID[i] * 255.0 + 0.5));\n\n    varyingObjectID = float(marked);\n\tcolorFrag = color;\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\n#define PHONG\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n\nvarying float varyingObjectID;\nvarying vec3 colorFrag;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n    vec3 marked = vec3(float(varyingObjectID > 0.5) * 0.5 + 0.5, 0.5, 0.5);\n\n\tvec4 diffuseColor = vec4(diffuse, opacity);\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\t//vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tvec3 outgoingLight = clamp(reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance, 0.75, 1.0) * colorFrag;\n\t//vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t\n\tif (varyingObjectID > 0.5) \n\t\toutgoingLight -= vec3(0.0, 0.6, 0.6); \n\n\n\t//outgoingLight -= vec3(0.8);\n\t//vec3 shade = outgoingLight;\n\t//const vec3 slices = vec3(10.0);\n\t//const vec3 slices_inv = vec3(1.0) / slices;\n\t//outgoingLight *= vec3(5.0);\n\t//outgoingLight *= slices;\n\t//outgoingLight = floor(outgoingLight + vec3(0.5));\n\t//outgoingLight *= slices_inv;\n\t//outgoingLight = pow(outgoingLight, vec3(0.4));\n\t//outgoingLight *= vec3(0.3);\n\t//outgoingLight += vec3(0.7);\n\n\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",lights:!0,side:mt.h,name:"custom-polygon-material"})}(),t.setupMaterial(this.polygonSelectMaterial),this.lineMaterial=function(){var e=mt.M.merge([{zoffset:{value:1}}]);return new mt.J({uniforms:e,vertexShader:"\n#define PHONG\n\nvarying vec3 vViewPosition;\n\nattribute vec3 lineStart;\nattribute vec3 lineEnd;\nuniform float zoffset;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n/**\n * Create rotation matrix from field vector.\n * The returned matrix can rotate vector (1, 0, 0)\n * into the desired setup.\n */\nmat4 getRotationMat(vec3 vector)\n{\n\tvec3 unit = vec3(1, 0, 0);\n\tvec3 f = normalize(vector);\n\tvec3 cross = cross(f, unit);\n\tvec3 a = normalize(cross);\n\tfloat s = length(cross);\n\tfloat c = dot(f, unit);\n\tfloat oc = 1.0 - c;\n\treturn mat4(oc * a.x * a.x + c,        oc * a.x * a.y - a.z * s,  oc * a.z * a.x + a.y * s,  0.0,\n                oc * a.x * a.y + a.z * s,  oc * a.y * a.y + c,        oc * a.y * a.z - a.x * s,  0.0,\n                oc * a.z * a.x - a.y * s,  oc * a.y * a.z + a.x * s,  oc * a.z * a.z + c,        0.0,\n                0.0,                       0.0,                       0.0,                       1.0);\n\n}\n\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\n\tvec3 dir = lineEnd - lineStart;\n    float dist = length(dir);\n    mat4 rot = getRotationMat(dir);\n\n\tconst float thickness = 1.0;\n\tfloat end = float(transformed.x >= 0.9);\n\ttransformed.x = end * (dist - 1.0 + transformed.x) + (1.0 - end) * transformed.x; //subtract one because its the original length of the template line\n\ttransformed.y *= thickness;\n\n    transformed = lineStart + (rot * vec4(transformed, 1.0)).xyz;\n\ttransformed.z += zoffset;\n\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\n#define PHONG\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t//#include <lights_phong_fragment>\n\t//#include <lights_fragment_begin>\n\t//#include <lights_fragment_maps>\n\t//#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",side:mt.h,name:"custom-line-material"})}(),this.pickingMaterial=function(){var e=mt.M.merge([]);return new mt.J({uniforms:e,vertexShader:"\nattribute vec4 objectID;\nvarying vec4 objectIDColor;\n\nvoid main() {\n    objectIDColor = objectID;\n    gl_Position = projectionMatrix * (modelViewMatrix * vec4( position, 1.0 ));\n}\n",fragmentShader:"\nvarying vec4 objectIDColor;\n\nvoid main() {\n\tgl_FragColor = vec4(objectIDColor);\n}\n",side:mt.h,name:"custom-picking-material"})}(),this.lineSelectorMaterial=new mt.p({color:0})},Dt=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i){var a;return Object(ut.a)(this,n),e.up=new mt.O(0,0,1),(a=t.call(this,e,i)).screenSpacePanning=!1,a.mouseButtons.LEFT=mt.s.PAN,a.mouseButtons.RIGHT=mt.s.ROTATE,a.touches.ONE=mt.L.PAN,a.touches.TWO=mt.L.DOLLY_ROTATE,a.zoomSpeed=.5,a.dampingFactor=.1,a.enableDamping=!0,a.minDistance=400,a.minPolarAngle=.001,a.maxPolarAngle=.4*Math.PI,a.update(),a}return n}(n(138).a),Tt=function(){function e(t){Object(ut.a)(this,e),this.camera=void 0,this.camera=new mt.C(65,window.innerWidth/window.innerHeight,1,6e3)}return Object(pt.a)(e,[{key:"update",value:function(e){e.update()}},{key:"topView",value:function(e){this.camera.position.copy(e.target),this.camera.position.z=3e3,this.camera.updateMatrixWorld()}},{key:"enable",value:function(e){e.enableRotate=!0,e.maxDistance=5e3}},{key:"resize",value:function(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}}]),e}(),At=function(){function e(t,n){Object(ut.a)(this,e),this.camera=void 0,this.csm=void 0,this.camera=new mt.A(-window.innerWidth/2,window.innerWidth/2,window.innerHeight/2,-window.innerHeight/2,1,8e3),this.csm=n}return Object(pt.a)(e,[{key:"update",value:function(e){var t=e.target.distanceTo(e.object.position),n=e.object.aspect;this.camera.left=t*n/-2,this.camera.right=t*n/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.position.copy(e.object.position),this.camera.updateProjectionMatrix(),e.update(),this.csm.updateFrustums()}},{key:"enable",value:function(e){this.camera.position.copy(e.object.position),e.target.copy(this.camera.position),e.target.z=0,e.maxDistance=3e3,e.enableRotate=!1}},{key:"topView",value:function(e){this.camera.position.copy(e.target),this.camera.position.z=3e3,this.camera.updateMatrixWorld()}},{key:"resize",value:function(e,t){this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix()}}]),e}(),Pt=function(){function e(t){Object(ut.a)(this,e),this.controls=void 0,this.perspective=void 0,this.orthographic=void 0,this.current=void 0,this.csm=void 0,this.perspective=new Tt(t),this.controls=new Dt(this.perspective.camera,t),this.current=this.perspective,this.current.enable(this.controls)}return Object(pt.a)(e,[{key:"initOrthographic",value:function(e,t){this.orthographic=new At(e,t),this.csm=t}},{key:"resize",value:function(e,t){this.perspective.resize(e,t),this.orthographic&&this.orthographic.resize(e,t)}},{key:"update",value:function(){this.current.update(this.controls)}},{key:"enable",value:function(){this.current.enable(this.controls)}},{key:"topView",value:function(){this.current.topView(this.controls)}},{key:"camera",get:function(){return this.current.camera}},{key:"target",get:function(){return this.controls.target}},{key:"swap",value:function(){this.orthographic&&this.csm&&(this.current.topView(this.controls),this.current=this.current===this.perspective?this.orthographic:this.perspective,this.current.enable(this.controls),this.csm.camera=this.current.camera,this.csm.updateFrustums())}},{key:"focus",value:function(e){this.controls.target=new mt.O(e.x,e.y,0),this.current.camera.position.x=e.x,this.current.camera.position.y=e.y,this.current.camera.position.z=1e3}},{key:"screenToWorldOrthographic",value:function(e,t){if(this.current.camera.isOrthographicCamera){var n=this.current.camera,i=new mt.O;return i.set(e/window.innerWidth*2-1,-t/window.innerHeight*2+1,(n.near+n.far)/(n.near-n.far)),i.unproject(n)}}}]),e}(),Rt=function(){function e(t,n){Object(ut.a)(this,e),this.name=void 0,this.counter=void 0,this.manager=void 0,this.name=t,this.counter=0,this.manager=n}return Object(pt.a)(e,[{key:"start",value:function(){this.counter++,this.manager.update()}},{key:"stop",value:function(){this.counter--,this.manager.update()}},{key:"toString",value:function(){return"".concat(this.name,": ").concat(this.counter," remaining")}},{key:"isRunning",get:function(){return this.counter>0}}]),e}(),It=function(){function e(){Object(ut.a)(this,e),this.actions=void 0,this.actions={loadingGeometry:new Rt("Loading Geometry",this),parsingGeometry:new Rt("Parsing Geometry",this),loadingStyles:new Rt("Loading Styles",this),applyingStyles:new Rt("Applying Styles",this)}}return Object(pt.a)(e,[{key:"update",value:function(){var e=document.getElementById("viewStatusBar");if(e){for(var t in this.actions)if(this.actions[t].isRunning){var n=this.actions[t].toString();return void(e.innerHTML=n)}e.innerHTML="Ready."}}}]),e}(),Ft=function(){function e(t,n){Object(ut.a)(this,e),this.canvas=void 0,this.scene=void 0,this.pickingScene=void 0,this.renderer=void 0,this.controls=void 0,this.picker=void 0,this.matlib=void 0,this.csm=void 0,this.helper=void 0,this.stats1=void 0,this.stats2=void 0,this.changed=void 0,this.updateLights=!0,this.actionCall=void 0,this.status=void 0,this.trim=0,this.canvas=t,this.actionCall=n,this.status=new It,this.scene=new mt.G,this.pickingScene=new mt.G,this.controls=new Pt(this.canvas),this.renderer=new mt.Q({canvas:this.canvas,antialias:!0}),this.setupRenderer(),this.setupLightsAndShadows(),this.controls.initOrthographic(this.canvas,this.csm),this.matlib=new Nt(this.csm),this.picker=new Ct(this.renderer),this.changed=!0}return Object(pt.a)(e,[{key:"setupLightsAndShadows",value:function(){var e=new mt.l(16777215,5592405,.4);e.position.set(0,1,1),this.scene.add(e),this.scene.add(new mt.a(16777215,.5)),this.csm=new wt({fade:!0,mode:"practical",cascades:4,shadowBias:[-5e-4,-.001,-.001,-.003],shadowMapSize:2048,lightDirection:new mt.O(-1,-1,-1).normalize(),camera:this.controls.camera,parent:this.scene,lightNear:1,lightFar:1e4,maxFar:5e3,margin:0,lightIntensity:.2,autoUpdateHelper:!1}),this.helper=new kt(this.csm),this.helper.visible=!0,this.scene.add(this.helper),this.helper.update()}},{key:"setupRenderer",value:function(){var e=this;this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!1,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.type=mt.B,this.renderer.setClearColor(10944499),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setAnimationLoop((function(){return e.frame()}))}},{key:"frame",value:function(){this.actionCall(),this.controls.update(),this.changed&&(this.updateLights&&(this.csm.update(),this.renderer.shadowMap.needsUpdate=!0),this.renderer.render(this.scene,this.controls.camera)),this.changed=!1}},{key:"click",value:function(e,t){var n=this.picker.pick(e,t,this.pickingScene,this.controls.camera);return this.select(n)}},{key:"select",value:function(e){this.picker.id!=e&&this.picker.select(e);var t=this.picker.layerAndOidForId(e);return this.matlib.polygonSelectMaterial.uniforms.selectedID=t?{value:this.picker.selected}:{value:[-1,-1,-1,-1]},this.matlib.polygonSelectMaterial.uniformsNeedUpdate=!0,this.changed=!0,t}},{key:"updateHelper",value:function(){this.helper.update(),this.updateLights=!1,this.changed=!0}},{key:"resize",value:function(e,t){this.controls.resize(e,t),this.renderer.setSize(e,t),this.changed=!0}}]),e}();!function(e){e[e.NOSELECT=0]="NOSELECT",e[e.SELECT=1]="SELECT",e[e.SELECTEDFIRST=2]="SELECTEDFIRST"}(Mt||(Mt={}));var Bt,zt=function(){function e(t){Object(ut.a)(this,e),this.renderer=void 0,this.status=Mt.NOSELECT,this.cube=void 0,this.ends=void 0,this.renderer=t;var n=function(e,t,n){e*=.5,t*=.5,n*=.5;var i=new mt.e,a=[];return a.push(-e,-t,-n,-e,t,-n,-e,t,-n,e,t,-n,e,t,-n,e,-t,-n,e,-t,-n,-e,-t,-n,-e,-t,n,-e,t,n,-e,t,n,e,t,n,e,t,n,e,-t,n,e,-t,n,-e,-t,n,-e,-t,-n,-e,-t,n,-e,t,-n,-e,t,n,e,t,-n,e,t,n,e,-t,-n,e,-t,n),i.setAttribute("position",new mt.j(a,3)),i}(1,1,1),i=new mt.q({color:0,dashSize:3,gapSize:1});this.cube=new mt.r(n,i),this.renderer.scene.add(this.cube),this.ends=[],this.cube.visible=!1}return Object(pt.a)(e,[{key:"select",value:function(e,t){if(this.ends.push(new mt.N(e,t)),this.cube.visible=!0,this.renderer.changed=!0,this.ends.length<2)return this.cube.position.x=e,this.cube.position.y=t,this.cube.position.z=0,this.cube.scale.set(10,10,1e3),this.cube.updateMatrixWorld(),{start:[e,t]};var n=this.ends.pop(),i=this.ends.pop(),a=new mt.N(n.x,n.y);return a.min(i),n.max(i),i.copy(n).sub(a),this.cube.scale.set(i.x,i.y,1e3),this.cube.position.set(a.x+.5*i.x,a.y+.5*i.y,0),this.cube.updateMatrixWorld(),{start:[a.x,a.y],end:[n.x,n.y],size:[i.x,i.y]}}},{key:"clear",value:function(){this.cube.visible=!1,this.renderer.changed=!0}}]),e}(),Ut=n(58),Ht=n(16),Gt=n(17),Vt=function(){function e(){Object(ut.a)(this,e)}return Object(pt.a)(e,null,[{key:"base64tofloat32",value:function(e,t,n){var i={p:0,it:1,view:new DataView(new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT)),blob:window.atob(e)},a=i.blob.length/Float64Array.BYTES_PER_ELEMENT;i.array=new Float32Array(a),i.totalStop=a*Float64Array.BYTES_PER_ELEMENT,Promise.resolve(i).then((function e(i){for(var a=1e5*i.it*Float64Array.BYTES_PER_ELEMENT,r=Math.min(a,i.totalStop);i.p<r;i.p+=Float64Array.BYTES_PER_ELEMENT){for(var s=0;s<Float64Array.BYTES_PER_ELEMENT;++s)i.view.setUint8(s,i.blob.charCodeAt(i.p+s));i.array[i.p/Float64Array.BYTES_PER_ELEMENT]=i.view.getFloat64(0,!0)}t()||(i.p<i.totalStop?(i.it++,Promise.resolve(i).then(e)):n(i.array),i=null)})),i=null}},{key:"base64toint32",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=function e(a){for(var r=1e5*a.it*Int32Array.BYTES_PER_ELEMENT,s=Math.min(r,a.totalStop);a.p<s;a.p+=Int32Array.BYTES_PER_ELEMENT){for(var o=0;o<Int32Array.BYTES_PER_ELEMENT;++o)a.view.setUint8(o,a.blob.charCodeAt(a.p+o));a.array[a.p/Int32Array.BYTES_PER_ELEMENT]=a.view.getInt32(0,!0)+t}n()||(a.p<a.totalStop?(a.it++,Promise.resolve(a).then(e)):i(new Uint8Array(a.array.buffer)),a=null)},r={p:0,it:1,view:new DataView(new ArrayBuffer(Int32Array.BYTES_PER_ELEMENT)),blob:window.atob(e)},s=r.blob.length/Int32Array.BYTES_PER_ELEMENT;r.array=new Int32Array(s),r.totalStop=s*Int32Array.BYTES_PER_ELEMENT,Promise.resolve(r).then(a),r=null}},{key:"base64touint8",value:function(e,t){var n={p:0,it:1,blob:window.atob(e)},i=n.blob.length/Uint8Array.BYTES_PER_ELEMENT;n.array=new Uint8Array(i),n.totalStop=i,Promise.resolve(n).then((function e(n){for(var i=1e6*n.it*Uint8Array.BYTES_PER_ELEMENT,a=Math.min(i,n.totalStop);n.p<a;n.p+=Uint8Array.BYTES_PER_ELEMENT)n.array[n.p]=n.blob.charCodeAt(n.p);n.p<n.totalStop?(n.it++,Promise.resolve(n).then(e)):t(n.array),n=null})),n=null}}]),e}(),Wt=function(){function e(t){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};Object(ut.a)(this,e),this.styles=void 0,this.styles=t||{},this.styles.buffer&&Vt.base64touint8(this.styles.buffer,(function(e){n.styles.buffer=e,i(n)})),this.styles.buffer_source&&this.styles.buffer_target&&Vt.base64touint8(this.styles.buffer_source,(function(e){n.styles.buffer_source=e,Vt.base64touint8(n.styles.buffer_target,(function(e){n.styles.buffer_target=e,i(n)}))}))}return Object(pt.a)(e,[{key:"pickable",get:function(){return!this.styles.pickable||this.styles.pickable}},{key:"visible",get:function(){return!this.styles.visible||this.styles.visible}},{key:"color_buffer",get:function(){if(this.styles.buffer)return this.styles.buffer;throw new Error("No colors defined")}},{key:"color_buffer_target",get:function(){if(this.styles.buffer_target)return this.styles.buffer_target;throw new Error("No target colors defined")}},{key:"color_buffer_source",get:function(){if(this.styles.buffer_source)return this.styles.buffer_source;throw new Error("No source colors defined")}}]),e}();function Yt(e,t,n,i,a){Promise.resolve({i:0,ci:0,it:1,total_stop:t.length/Uint32Array.BYTES_PER_ELEMENT,view:new DataView(t.buffer)}).then((function t(r){for(var s,o=1e5*r.it,c=Math.min(o,r.total_stop);r.i<c;r.i++)s=3*(r.view.getUint32(r.i*Uint32Array.BYTES_PER_ELEMENT,!0)-e),i[r.ci++]=n[s],i[r.ci++]=n[s+1],i[r.ci++]=n[s+2];r.i<r.total_stop?(r.it++,Promise.resolve(r).then(t)):a(),r=null}))}function Xt(e,t,n){Promise.resolve({i:0,ci:0,it:1,total_stop:e}).then((function e(i){for(var a=1e5*i.it*Uint8Array.BYTES_PER_ELEMENT,r=Math.min(a,i.total_stop);i.i<r;i.i++)t[i.ci++]=255,t[i.ci++]=255,t[i.ci++]=255;i.i<i.total_stop?(i.it++,Promise.resolve(i).then(e)):n(),i=null}))}!function(e){e[e.source=0]="source",e[e.target=1]="target",e[e.object=2]="object"}(Bt||(Bt={}));var $t=function(){function e(t){Object(ut.a)(this,e),this.renderer=void 0,this.mesh=void 0,this.pickingMesh=void 0,this.visibility=void 0,this.renderer=t,this.visibility=!0}return Object(pt.a)(e,[{key:"visible",set:function(e){this.visibility=e,this.mesh&&(this.mesh.visible=e)}},{key:"remove",value:function(){this.mesh=this.removeFrom(this.mesh,this.renderer.scene),this.pickingMesh=this.removeFrom(this.pickingMesh,this.renderer.pickingScene)}},{key:"removeFrom",value:function(e,t){e&&(t.remove(e),e.geometry.dispose())}},{key:"baseColors",value:function(e){for(var t=new Uint8Array(e),n=0;n<e;n++)t[n]=255;return t}},{key:"afterApplyStyle",value:function(){this.renderer.status.actions.applyingStyles.stop(),this.mesh&&(this.mesh.geometry.attributes.color.needsUpdate=!0,this.renderer.changed=!0)}},{key:"applyStyle",value:function(e,t,n){if(this.mesh&&this.mesh.geometry.attributes.objectID){this.renderer.status.actions.applyingStyles.start();var i=this.mesh.geometry.attributes.objectID.array,a=this.mesh.geometry.attributes.color.array;t?Yt(e,i,t.color_buffer,a,this.afterApplyStyle.bind(this)):Xt(i.length,a,this.afterApplyStyle.bind(this))}}}]),e}(),Kt=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(){return Object(ut.a)(this,n),t.apply(this,arguments)}return Object(pt.a)(n,[{key:"applyStyle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Bt.source;if(this.mesh&&this.mesh.geometry.attributes.objectID){this.renderer.status.actions.applyingStyles.start();var i=this.mesh.geometry.attributes.objectID.array,a=this.mesh.geometry.attributes.color.array;t?n===Bt.source?Yt(e,i,t.color_buffer_source,a,this.afterApplyStyle.bind(this)):Yt(e,i,t.color_buffer_target,a,this.afterApplyStyle.bind(this)):Xt(i.length,a,this.afterApplyStyle.bind(this))}}}]),n}($t),Jt=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;Object(ut.a)(this,n),s=t.call(this,i.renderer);var o=i.renderer.picker.offsetForLayer(i.layer.name);return Vt.base64tofloat32(e.vertices,r,(function(t){Vt.base64toint32(e.attributes.oid.data,o,r,(function(e){s.init(t,e,i),a(Object(Gt.a)(s))}))})),s}return Object(pt.a)(n,[{key:"init",value:function(e,t,n){var i=this.createGeometry(e,t);this.createMesh(i),this.createPickingMesh(i),this.visible=n.visible,this.renderer.changed=!0}},{key:"createPickingMesh",value:function(e){var t=new mt.v(e,this.renderer.matlib.pickingMaterial);this.renderer.pickingScene.add(t),this.pickingMesh=t}},{key:"createMesh",value:function(e){var t=this.renderer.matlib.polygonSelectMaterial,n=new mt.v(e,t);n.receiveShadow=!0,n.castShadow=!0,this.renderer.scene.add(n),this.mesh=n}},{key:"createGeometry",value:function(e,t){var n=new mt.e;return n.setAttribute("position",new mt.d(e,3)),n.setAttribute("objectID",new mt.d(t,4,!0)),n.setAttribute("color",new mt.d(this.baseColors(e.length),3,!0)),n.computeVertexNormals(),n}}]),n}($t),Zt=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;Object(ut.a)(this,n),s=t.call(this,i.renderer);var o=i.renderer.picker.offsetForLayer(i.layer.source);i.renderer.picker.offsetForLayer(i.layer.target);return Vt.base64tofloat32(e.vertices,r,(function(t){Vt.base64toint32(e.attributes.source_oid.data,o,r,(function(e){s.init(t,e,i),a(Object(Gt.a)(s))}))})),s}return Object(pt.a)(n,[{key:"init",value:function(e,t,n){var i=this.createGeometry(e,t);this.createMesh(i),this.createPickingMesh(i),this.visible=n.visible,this.renderer.changed=!0}},{key:"createPickingMesh",value:function(e){var t=new mt.v(e,this.renderer.matlib.pickingMaterial);this.renderer.pickingScene.add(t),this.pickingMesh=t}},{key:"createMesh",value:function(e){var t=this.renderer.matlib.polygonSelectMaterial,n=new mt.v(e,t);n.receiveShadow=!0,n.castShadow=!0,this.renderer.scene.add(n),this.mesh=n}},{key:"createGeometry",value:function(e,t){var n=new mt.e;return n.setAttribute("position",new mt.d(e,3)),n.setAttribute("objectID",new mt.d(t,4,!0)),n.setAttribute("color",new mt.d(this.baseColors(e.length),3,!0)),n.computeVertexNormals(),n}}]),n}(Kt);function qt(e){for(var t=[],n=Math.PI/2,i=Math.PI/e,a=0;a<e;++a)t.push(0,0,0),t.push(Math.cos(n+i*a),Math.sin(n+i*a),0),t.push(Math.cos(n+i*(a+1)),Math.sin(n+i*(a+1)),0);return t}function Qt(e){for(var t=[],n=Math.PI/2,i=Math.PI/e,a=0;a<e;++a)t.push(1,0,0),t.push(1-Math.cos(n+i*a),Math.sin(n+i*a),0),t.push(1-Math.cos(n+i*(a+1)),Math.sin(n+i*(a+1)),0);return t}function en(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=[0,-1,0,1,-1,0,1,1,0,0,-1,0,1,1,0,0,1,0];return t=(t=t.concat(qt(e))).concat(Qt(e))}var tn={model:{simplepolygon:Jt,simpleline:function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;Object(ut.a)(this,n),s=t.call(this,i.renderer);var o=i.renderer.picker.offsetForLayer(i.layer.name);return Vt.base64tofloat32(e.vertices,r,(function(t){Vt.base64toint32(e.attributes.oid.data,o,r,(function(e){var n=s.createGeometry(t);s.createMesh(n),s.visible=i.visible,s.renderer.changed=!0,a(Object(Gt.a)(s))}))})),s}return Object(pt.a)(n,[{key:"createMesh",value:function(e){var t=new mt.v(e,this.renderer.matlib.lineMaterial);t.frustumCulled=!1,this.renderer.scene.add(t),this.mesh=t}},{key:"createGeometry",value:function(e){var t=new mt.m;return t.instanceCount=e.length/3,t.setAttribute("position",new mt.d(new Float32Array(en()),3)),t.setAttribute("lineStart",new mt.o(new mt.n(e,6,1),3,0)),t.setAttribute("lineEnd",new mt.o(new mt.n(e,6,1),3,3)),t}}]),n}($t)},proxy:{simpleline:function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;Object(ut.a)(this,n),s=t.call(this,i.renderer);var o=i.renderer.picker.offsetForLayer(i.layer.source);return Vt.base64tofloat32(e.vertices,r,(function(t){Vt.base64toint32(e.attributes.oid.data,o,r,(function(e){var n=s.createGeometry(t);s.createMesh(n),s.visible=i.visible,s.renderer.changed=!0,a(Object(Gt.a)(s))}))})),s}return Object(pt.a)(n,[{key:"createMesh",value:function(e){var t=new mt.v(e,this.renderer.matlib.lineMaterial);t.frustumCulled=!1,this.renderer.scene.add(t),this.mesh=t}},{key:"createGeometry",value:function(e){var t=new mt.m;return t.instanceCount=e.length/3,t.setAttribute("position",new mt.d(new Float32Array(en()),3)),t.setAttribute("lineStart",new mt.o(new mt.n(e,6,1),3,0)),t.setAttribute("lineEnd",new mt.o(new mt.n(e,6,1),3,3)),t}}]),n}($t),simplepolygon:Zt}},nn=Object.keys(tn.model),an=Object.keys(tn.proxy);function rn(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){return!1};if(e.tags&&!0===e.tags.proxy){if(an.includes(e.type))return new tn.proxy[e.type](e,t,n,i);throw new Error("Proxy type ".concat(e.type," is not registered"))}if(nn.includes(e.type))return new tn.model[e.type](e,t,n,i);throw new Error("Model type ".concat(e.type," is not registered"))}var sn=function(){function e(){Object(ut.a)(this,e),this.stopFlag=void 0,this.loaded=void 0,this.loaded=!1}return Object(pt.a)(e,[{key:"get",value:function(e,t){var n=this;this.stopFlag=ee.a.CancelToken.source(),e.renderer.status.actions.loadingGeometry.start(),ne.get("/api/data/".concat(e.layer.project,"/").concat(e.layer.name,"/grid/tiles/").concat(e.sourceFile),{cancelToken:this.stopFlag.token}).then((function(i){e.renderer.status.actions.loadingGeometry.stop(),n.loaded||(n.loaded=!0,n.stopFlag=null,t(i.data))})).catch((function(t){e.renderer.status.actions.loadingGeometry.stop(),n.stopFlag=null}))}},{key:"abort",value:function(){this.stopFlag&&this.stopFlag.cancel(),this.stopFlag=null}}]),e}(),on=function(){function e(t,n,i){Object(ut.a)(this,e),this.bbox=void 0,this.brect=void 0,this.x=void 0,this.y=void 0,this.renderer=void 0,this.layer=void 0,this.sourceFile=void 0,this.models=void 0,this.isVisible=void 0,this.loader=void 0,this.bbox=[Object(Ut.a)(mt.O,Object(Ht.a)(t.box[0])),Object(Ut.a)(mt.O,Object(Ht.a)(t.box[1]))],this.brect=[new mt.N(this.bbox[0].x,this.bbox[0].y),new mt.N(this.bbox[1].x,this.bbox[1].y)],this.x=t.x,this.y=t.y,this.sourceFile=t.file,this.layer=i,this.renderer=n,this.isVisible=!1,this.models=[],this.loader=new sn}return Object(pt.a)(e,[{key:"visible",get:function(){return this.isVisible},set:function(e){this.isVisible!==e&&(this.isVisible=e,e?this.show():this.hide())}},{key:"show",value:function(){var e=this;this.loader.loaded||this.loader.get(this,(function(t){e.isVisible;var n,i=Object(Et.a)(t);try{for(i.s();!(n=i.n()).done;){var a=n.value;e.renderer.status.actions.parsingGeometry.start(),rn(a,e,(function(t){e.models.push(t),e.renderer.status.actions.parsingGeometry.stop(),e.isVisible,e.layer.applyStyleToModels(e.models),e.isVisible}),(function(){return!e.isVisible}))}}catch(r){i.e(r)}finally{i.f()}}));var t,n=Object(Et.a)(this.models);try{for(n.s();!(t=n.n()).done;){t.value.visible=!0}}catch(i){n.e(i)}finally{n.f()}}},{key:"hide",value:function(){this.loader.loaded||this.loader.abort();var e,t=Object(Et.a)(this.models);try{for(t.s();!(e=t.n()).done;){e.value.visible=!1}}catch(n){t.e(n)}finally{t.f()}}},{key:"remove",value:function(){if(this.models.length>0){var e,t=Object(Et.a)(this.models);try{for(t.s();!(e=t.n()).done;){e.value.remove()}}catch(n){t.e(n)}finally{t.f()}this.models=[]}}}]),e}();function cn(e,t){var n=Math.max(Math.abs(e),Math.abs(t));if(0===e&&0===t)return 0;var i,a=8*((i=n-1)*(i+1)/2);if(e>Math.abs(t)||e===t&&e>0)return a+n+t;if((t>Math.abs(e)||t===-e)&&t>0)return a+4*n-n-e;if(e<t||e===t&&e<0)return a+5*n-t;if(t<e||-t===e&&t<0)return a+7*n+e;throw new Error("Cannot covert to 1D")}var ln=function(){function e(t,n,i){Object(ut.a)(this,e),this.bbox=void 0,this.brect=void 0,this.focusPoint=void 0,this.renderer=void 0,this.tileSize=void 0,this.tiles=void 0,this.visible_radius=void 0,this.visible=void 0,this.visibleSwap=void 0,this.zero2=void 0,this.layer=void 0,this.tileSize=t.tile_size,this.renderer=n,this.layer=i,this.bbox=[new mt.O(1/0,1/0,1/0),new mt.O(-1/0,-1/0,-1/0)],this.tiles=new Map,this.createTiles(t,n,i),this.brect=[new mt.N(this.bbox[0].x,this.bbox[0].y),new mt.N(this.bbox[1].x,this.bbox[1].y)],this.focusPoint=new mt.N(1/0,1/0),this.visible_radius=2e3,this.visibleSwap=new Set,this.visible=new Set,this.zero2=new mt.N}return Object(pt.a)(e,[{key:"center",get:function(){return e=this.bbox,new mt.N(.5*(e[0].x+e[1].x),.5*(e[0].y+e[1].y));var e}},{key:"createTiles",value:function(e,t,n){var i,a,r,s=Object(Et.a)(e.tiles);try{for(s.s();!(i=s.n()).done;){var o=i.value,c=cn(o.x,o.y),l=new on(o,t,n);a=this.bbox,r=l.bbox,a[0].min(r[0]),a[1].max(r[1]),this.tiles.set(c,l)}}catch(d){s.e(d)}finally{s.f()}}},{key:"update_visible_tiles",value:function(e){var t=this.focusPoint.clone().divideScalar(this.tileSize).floor(),n=new mt.N(e.x,e.y).divideScalar(this.tileSize).floor();t.equals(n)||this.update_visibility(n)}},{key:"update_visibility",value:function(e){var t=this,n=this.visible;this.visible=this.visibleSwap,this.visibleSwap=n;var i=Math.ceil(this.visible_radius/this.tileSize),a=e.clone().subScalar(i),r=e.clone().addScalar(i+1);this.visible.clear();for(var s=a.x;s<r.x;++s)for(var o=a.y;o<r.y;++o){var c=cn(s,o),l=this.tiles.get(c);l&&(l.visible=!0,this.visible.add(l))}this.visibleSwap.forEach((function(e){t.visible.has(e)||(e.visible=!1)}))}}]),e}(),dn=function(){function e(t,n,i,a){Object(ut.a)(this,e),this.name=void 0,this.project=void 0,this.renderer=void 0,this.grid=void 0,this.style=void 0,this.name=i.name,this.project=n,this.renderer=t}return Object(pt.a)(e,[{key:"init",value:function(e){this.grid=new ln(e.layout,this.renderer,this),this.renderer.controls.focus(this.grid.center),this.grid.update_visible_tiles(this.renderer.controls.target),this.renderer.changed=!0}},{key:"update_visible_tiles",value:function(e){this.grid&&this.grid.update_visible_tiles(e)}},{key:"applyStyle",value:function(e){var t=this;ne.get("/api/data/".concat(this.project,"/styles/").concat(e,"/").concat(this.name,".json"),{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}}).then((function(e){new Wt(e.data,(function(e){t.style=e;var n,i=Object(Et.a)(t.grid.tiles);try{for(i.s();!(n=i.n()).done;){var a=Object(K.a)(n.value,2),r=(a[0],a[1]);t.applyStyleToModels(r.models)}}catch(s){i.e(s)}finally{i.f()}}))})).catch((function(e){var n,i=Object(Et.a)(t.grid.tiles);try{for(i.s();!(n=i.n()).done;){var a=Object(K.a)(n.value,2),r=(a[0],a[1]);t.applyStyleToModels(r.models)}}catch(s){i.e(s)}finally{i.f()}}))}}]),e}(),hn=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;return Object(ut.a)(this,n),(s=t.call(this,e,i,a,r)).size=void 0,s.size=a.size,s.renderer.picker.offsetForLayer(s.name,s.size),s.init(a),s}return Object(pt.a)(n,[{key:"applyStyleToModels",value:function(e){var t,n=this.renderer.picker.offsetForLayer(this.name),i=Object(Et.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;this.style&&a.applyStyle(n,this.style)}}catch(r){i.e(r)}finally{i.f()}}}]),n}(dn),un=function(e){Object(St.a)(n,e);var t=Object(Lt.a)(n);function n(e,i,a,r){var s;return Object(ut.a)(this,n),(s=t.call(this,e,i,a,r)).source=void 0,s.target=void 0,s.size=void 0,s.source=a.source,s.target=a.target,s.size=a.size,s.renderer.picker.offsetForLayer(s.source,s.size[0]),s.renderer.picker.offsetForLayer(s.target,s.size[1]),s.init(a),s}return Object(pt.a)(n,[{key:"applyStyleToModels",value:function(e){var t,n=this.renderer.picker.offsetForLayer(this.source),i=Object(Et.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;this.style&&a.applyStyle(n,this.style)}}catch(r){i.e(r)}finally{i.f()}}}]),n}(dn),pn=function(){function e(t,n){var i=this;Object(ut.a)(this,e),this.name=void 0,this.renderer=void 0,this.layers=void 0,this.styles=void 0,this.name=t,this.renderer=n,this.layers=[],this.styles=[],ne.get("/api/data/".concat(this.name,"/layout.json")).then((function(e){var t=e.data.styles;i.styles=t;var n,a=Object(Et.a)(e.data.layers);try{for(a.s();!(n=a.n()).done;){var r=n.value;r.init&&!r.disabled&&("layer"===r.type&&i.layers.push(new hn(i.renderer,i.name,r,t)))}}catch(l){a.e(l)}finally{a.f()}var s,o=Object(Et.a)(e.data.layers);try{for(o.s();!(s=o.n()).done;){var c=s.value;c.init&&!c.disabled&&("overlay"===c.type&&i.layers.push(new un(i.renderer,i.name,c,t)))}}catch(l){o.e(l)}finally{o.f()}}))}return Object(pt.a)(e,[{key:"update_visible_tiles",value:function(e){var t,n=Object(Et.a)(this.layers);try{for(n.s();!(t=n.n()).done;){t.value.update_visible_tiles(e)}}catch(i){n.e(i)}finally{n.f()}}},{key:"applyStyle",value:function(e){if(-1!==this.styles.indexOf(e)){var t,n=Object(Et.a)(this.layers);try{for(n.s();!(t=n.n()).done;){t.value.applyStyle(e)}}catch(i){n.e(i)}finally{n.f()}}}}]),e}(),mn=function(){function e(t,n){var i=this;Object(ut.a)(this,e),this.project_name=void 0,this.canvas=void 0,this.renderer=void 0,this.selector=void 0,this.project=void 0,this.keymap=void 0,this.showMetaCallback=void 0,this.project_name=t,this.canvas=n,this.renderer=new Ft(this.canvas,(function(){return i.actions()})),this.selector=new zt(this.renderer),this.keymap={}}return Object(pt.a)(e,[{key:"init",value:function(){var e=this;this.project=new pn(this.project_name,this.renderer),this.renderer.controls.controls.addEventListener("change",(function(){return e.moved()}))}},{key:"moved",value:function(){this.project.update_visible_tiles(this.renderer.controls.target),this.renderer.changed=!0}},{key:"select",value:function(e){this.renderer.select(e)}},{key:"doubleclick",value:function(e,t){var n=this,i=this.renderer.click(e,t);console.log("doubleclick",i),i&&ne.post(E,{project:this.project_name,layer:i.layer,oid:i.oid}).then((function(e){console.log(e.data);var t=e.data;t.oid=i.oid,t.layer=i.layer,n.showMetaCallback&&n.showMetaCallback(e.data)}))}},{key:"keyDown",value:function(e){console.log("key down",e),this.keymap[e]=!0}},{key:"keyUp",value:function(e){console.log("key up",e),this.keymap[e]=!1}},{key:"actions",value:function(){this.keymap.KeyA&&(this.renderer.controls.swap(),this.keymap.KeyA=!1),this.keymap.KeyU&&(this.renderer.updateHelper(),this.keymap.KeyU=!1)}},{key:"resize",value:function(e,t){this.renderer.resize(e,t)}},{key:"exit",value:function(){}}]),e}();function fn(){var e=Object(l.h)().project_name,t=Object(i.useState)(!1),n=Object(K.a)(t,2),a=n[0],r=n[1],s=function(){var e=Object(i.useState)([0,0]),t=Object(K.a)(e,2),n=t[0],a=t[1];return Object(i.useLayoutEffect)((function(){function e(){a([window.innerWidth,window.innerHeight])}return window.addEventListener("resize",e),e(),function(){return window.removeEventListener("resize",e)}}),[]),n}(),o=Object(K.a)(s,2),c=o[0],d=o[1],h=Object(i.useState)(void 0),u=Object(K.a)(h,2),p=u[0],m=u[1],f=Object(i.createRef)(),b=Object(i.useState)({}),g=Object(K.a)(b,2),v=g[0],j=g[1],y=Object(i.useState)(!1),O=Object(K.a)(y,2),x=O[0],_=O[1],w=function(e){j(e),_(!0)};return Object(i.useEffect)((function(){if(null!=f.current){var t=new mn(e,f.current);return t.init(),t.renderer.frame(),t.showMetaCallback=w,m(t),function(){t.exit(),window.location.reload()}}}),[e]),Object(i.useEffect)((function(){null!=p&&p.resize(c,d)}),[c,d]),Object(re.jsxs)(J.a,{className:"canvasAnchor",children:[Object(re.jsx)(Ke.a,{isShown:a,onCloseComplete:function(){return r(!1)},preventBodyScrolling:!0,children:Object(re.jsxs)(J.a,{className:"viewSettings",children:["Menu",null===p||void 0===p?void 0:p.project.layers.map((function(e){return Object(re.jsx)(J.a,{children:e.name},e.name)})),null===p||void 0===p?void 0:p.project.styles.map((function(e){return Object(re.jsx)(J.a,{onClick:function(){return function(e){null!=p&&p.project.applyStyle(e)}(e)},children:e},e)}))]})}),Object(re.jsx)(dt.a,{title:"Metadata",hasCancel:!1,hasFooter:!1,width:"auto",isShown:x,onCloseComplete:function(){null===p||void 0===p||p.select(-1),_(!1)},onCancel:function(){null===p||void 0===p||p.select(-1),_(!1)},children:Object(re.jsx)(J.a,{className:"meta",children:Object.keys(v).map((function(e){return Object(re.jsxs)(J.a,{className:"attribute",children:[Object(re.jsxs)(Ve.a,{className:"key",children:[e,":"]})," ",Object(re.jsx)(Ve.a,{className:"value",children:v[e]})]},e)}))})}),Object(re.jsx)(J.a,{className:"viewControls",children:Object(re.jsx)(ke.a,{icon:ht.a,appearance:"minimal",onClick:function(){return r(!0)}})}),Object(re.jsx)("canvas",{ref:f,onDoubleClick:function(e){p&&p.doubleclick(e.clientX,e.clientY)},onKeyDown:function(e){!e.repeat&&p&&p.keyDown(e.code)},onKeyUp:function(e){!e.repeat&&p&&p.keyUp(e.code)},tabIndex:0,children:"Your browser does not support HTML5 canvas"}),Object(re.jsx)(J.a,{id:"viewStatusBar",children:"Status"})]})}var bn=n(343),gn=n(139),vn=n(36),jn={defaultToken:"",number:/\d+(\.\d+)?/,keywords:["@layer","@target","@source","@meta"],typeKeywords:["@default","@color","@visible"],symbols:/[=><!~?:&|+\-*\/\^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,regexpctl:/[(){}\[\]\$\^|\-*+?\.]/,regexpesc:/\\(?:[bBdDfnrstvwWn0\\\/]|@regexpctl|c[A-Z]|x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4})/,tokenizer:{root:[[/[{}]/,"delimiter.bracket"],{include:"common"}],common:[[/@[a-z_$][\w$]*/,{cases:{"@typeKeywords":"keyword","@keywords":"type.identifier","@default":"identifier"}}],{include:"@whitespace"},[/\/(?=([^\\\/]|\\.)+\/([gimsuy]*)(\s*)(\.|;|\/|,|\)|\]|\}|$))/,{token:"regexp",bracket:"@open",next:"@regexp"}],[/[()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@default":""}}],[/(@digits)[eE]([\-+]?(@digits))?/,"number.float"],[/(@digits)\.(@digits)([eE][\-+]?(@digits))?/,"number.float"],[/0[xX](@hexdigits)/,"number.hex"],[/#(@hexdigits)/,"number.hex"],[/0[oO]?(@octaldigits)/,"number.octal"],[/0[bB](@binarydigits)/,"number.binary"],[/(@digits)/,"number"],[/[;,.]/,"delimiter"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/`/,"string","@string_backtick"]],whitespace:[[/[ \t\r\n]+/,""]],regexp:[[/(\{)(\d+(?:,\d*)?)(\})/,["regexp.escape.control","regexp.escape.control","regexp.escape.control"]],[/(\[)(\^?)(?=(?:[^\]\\\/]|\\.)+)/,["regexp.escape.control",{token:"regexp.escape.control",next:"@regexrange"}]],[/(\()(\?:|\?=|\?!)/,["regexp.escape.control","regexp.escape.control"]],[/[()]/,"regexp.escape.control"],[/@regexpctl/,"regexp.escape.control"],[/[^\\\/]/,"regexp"],[/@regexpesc/,"regexp.escape"],[/\\\./,"regexp.invalid"],[/(\/)([gimsuy]*)/,[{token:"regexp",bracket:"@close",next:"@pop"},"keyword.other"]]],regexrange:[[/-/,"regexp.escape.control"],[/\^/,"regexp.invalid"],[/@regexpesc/,"regexp.escape"],[/[^\]]/,"regexp"],[/\]/,{token:"regexp.escape.control",next:"@pop",bracket:"@close"}]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],string_backtick:[[/\$\{/,{token:"delimiter.bracket",next:"@bracketCounting"}],[/[^\\`$]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/`/,"string","@pop"]],bracketCounting:[[/\{/,"delimiter.bracket","@bracketCounting"],[/\}/,"delimiter.bracket","@pop"],{include:"common"}]}},yn={brackets:[["{","}"],["[","]"],["(",")"]]};function On(e){return[{label:"Layer class",kind:vn.a.CompletionItemKind.Class,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Layer style class",insertText:"layer (${1:layer-key}) {\n    ${2:@properties}\n}",range:e},{label:"Target styles",kind:vn.a.CompletionItemKind.Class,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Styles based on metadata of the overlay source layer",insertText:"target {\n    ${1:value}\n}",range:e},{label:"Source styles",kind:vn.a.CompletionItemKind.Class,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Styles based on metadata of the overlay target layer",insertText:"source {\n    ${1:value}\n}",range:e},{label:"Meta class",kind:vn.a.CompletionItemKind.Class,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Styles based on metadata of the layer",insertText:"meta (${1:identifier}) {\n    ${2:value}\n}",range:e},{label:"Color value",kind:vn.a.CompletionItemKind.Value,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Color style class",insertText:"color: #${1:color};",range:e},{label:"Visibility value",kind:vn.a.CompletionItemKind.Value,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Visibility style class",insertText:"visible: ${1:boolean};",range:e},{label:"Default value",kind:vn.a.CompletionItemKind.Value,insertTextRules:vn.a.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Default style class",insertText:"default: ${1:value};",range:e}]}var xn=new RegExp(/^(\s*)/.source+/@[a-zA-Z]+/.source+/(\s*)$/.source,"mg");function _n(){var e=Object(l.h)(),t=e.project_name,n=e.style_name,a=Object(l.g)(),r=Object(i.useState)(void 0),s=Object(K.a)(r,2),o=s[0],c=s[1];Object(i.useEffect)((function(){o&&ne.post(H,{project:t,name:n}).then((function(e){var t=e.data;o.setValue(t.style)})).catch((function(e){console.error(e)}))}),[o]);var d=Object(i.useState)(!1),h=Object(K.a)(d,2),u=h[0],p=h[1],m=Object(i.useState)(""),b=Object(K.a)(m,2),g=b[0],v=b[1];return Object(re.jsxs)(J.a,{children:[Object(re.jsx)(oe,{projects:!0}),Object(re.jsxs)(J.a,{className:"stylesHeader",children:[Object(re.jsxs)(Z.a,{className:"wide",children:["Style ",n]}),Object(re.jsxs)(q.a,{marginRight:12,appearance:"minimal",iconBefore:de.a,onClick:function(){a.push(f+t)},children:["Back to Project ",t]}),Object(re.jsx)(dt.a,{title:"Style Parsed",hasCancel:!1,hasFooter:!1,width:"auto",isShown:u,onCloseComplete:function(){return p(!1)},children:Object(re.jsx)(nt.a,{className:"parsedMessage",children:g})}),Object(re.jsx)(q.a,{marginRight:12,appearance:"minimal",iconBefore:Ze.a,onClick:function(){if(o){var e=o.getValue();ne.post($,{project:t,name:n,styles:e}).then((function(e){"error"===e.data.status?(v(e.data.error),p(!0)):(v("Style parsed successfuly"),p(!0))})).catch((function(e){console.error(e)}))}},children:"Parse"}),Object(re.jsx)(we,{submitUrl:V,title:"Save style ".concat(n),label:"Are you sure you want to save style ".concat(n,"? Your previously compiled styles will be overwriten."),confirmLabel:"Overwrite",method:"post",submitBody:function(){if(!o)throw new Error("Error occured while saving the style.");return{project:t,name:n,styles:o.getValue()}},onSubmit:function(){console.log("Style ".concat(n," saved"))},onError:function(e){return"Style could not be saved"},tooltip:"Saves the new configuration and overwrites previously saved styles.",children:Object(re.jsx)(q.a,{marginRight:12,appearance:"minimal",iconBefore:bn.a,children:"Save"})}),Object(re.jsx)(we,{submitUrl:V,title:"Apply style ".concat(n),label:"Are you sure you want to recompile style ".concat(n,"?  Your previously compiled styles will be overwriten."),confirmLabel:"Compile",method:"post",submitBody:function(){if(!o)throw new Error("Error occured while saving the style.");return{project:t,name:n,styles:o.getValue()}},onSubmit:function(){ne.post(X,{project:t,name:n}).then((function(e){Object(Ye.b)("Compilation job submitted")})).catch((function(e){Object(Ye.b)("Job could not be submitted")}))},onError:function(e){return"Style could not be recompiled"},tooltip:"Recompile styles after updating to view the changes in the visualization",children:Object(re.jsx)(q.a,{appearance:"minimal",iconBefore:pe.a,children:"Save and Compile"})})]}),Object(re.jsx)(J.a,{className:"styles",children:Object(re.jsx)(gn.a,{beforeMount:function(e){e.languages.getLanguages().some((function(e){return"estimatemd"===e.id}))||(e.languages.register({id:"estimatemd"}),e.languages.setMonarchTokensProvider("estimatemd",jn),e.languages.setLanguageConfiguration("estimatemd",yn),e.languages.registerCompletionItemProvider("estimatemd",{provideCompletionItems:function(e,t){if(!e.getValueInRange({startLineNumber:0,startColumn:0,endLineNumber:t.lineNumber,endColumn:t.column}).match(xn))return{suggestions:[]};var n=e.getWordUntilPosition(t);return{suggestions:On({startLineNumber:t.lineNumber,endLineNumber:t.lineNumber,startColumn:n.startColumn,endColumn:n.endColumn})}}}))},onMount:function(e,t){c(e)},className:"editor",height:"100%",defaultLanguage:"estimatemd"})})]})}function wn(){return Object(re.jsxs)(c.a,{children:[Object(re.jsx)(Ye.a,{position:"top-center",autoClose:5e3,hideProgressBar:!1,newestOnTop:!1,closeOnClick:!0,rtl:!1,pauseOnFocusLoss:!0}),Object(re.jsxs)(l.d,{children:[Object(re.jsx)(l.b,{exact:!0,path:["/"],children:Object(re.jsx)(l.a,{to:"/app"})}),Object(re.jsx)(l.b,{path:h,children:Object(re.jsx)(Te,{})}),Object(re.jsx)(l.b,{path:O,children:Object(re.jsx)(lt,{})}),Object(re.jsx)(l.b,{path:g,children:Object(re.jsx)($e,{})}),Object(re.jsx)(l.b,{path:m,children:Object(re.jsx)(Ue,{})}),Object(re.jsx)(l.b,{path:j,children:Object(re.jsx)(_n,{})}),Object(re.jsx)(l.b,{path:b,children:Object(re.jsx)(rt,{})}),Object(re.jsx)(l.b,{path:u,children:Object(re.jsx)(fn,{})}),Object(re.jsx)(l.b,{path:d,children:Object(re.jsx)(ce,{})})]})]})}s.a.render(Object(re.jsx)(a.a.StrictMode,{children:Object(re.jsx)(o.a.Provider,{value:{className:"react-icons"},children:Object(re.jsx)(wn,{})})}),document.getElementById("root"))}},[[291,1,2]]]);
//# sourceMappingURL=main.33406093.chunk.js.map